# PostDockShapeSimilarity: Usage and Detailed Workflow

This document explains how to configure and use the PostDockShapeSimilarity component for Reinvent-Scoring, and details its end‑to‑end workflow.

## What it does

PostDockShapeSimilarity computes shape similarity scores for docked PROTAC poses using Roshambo. For each epoch, it:
- Creates an overlays directory (if not already present)
- Copies the reference warheads SDF into the overlays directory once (first use)
- Builds the epoch docked SDF filename (e.g., `e0001_ADV_ligands_docked.sdf`) from `docked_poses_path`
- Extracts warheads from the docked SDF into `eXXXX_e_warheads.sdf` in the overlays directory
- Calls the Roshambo Flask API using filename-only paths from the overlays directory
- Reads `eXXXX_roshambo.csv` and maps best per‑molecule scores back to the batch

Outputs created in the overlays directory per epoch:
- `eXXXX_e_warheads.sdf` — extracted warheads dataset (Roshambo input)
- `eXXXX_mols.sdf`, `eXXXX_hits.sdf`, `eXXXX_roshambo.csv` — generated by Roshambo

## Prerequisites

- A Roshambo Flask API running locally (default `http://127.0.0.1:5000`) with the `/similarity` endpoint.
- Docked poses are written per epoch under `docked_poses_path` with filenames:
  - `e0001_ADV_ligands_docked.sdf`, `e0002_ADV_ligands_docked.sdf`, ...
- A reference warheads SDF file (POI/E3 warheads) to compare against.

## JSON configuration example

```json
{
  "component_type": "docked_parallel_roshambo_similarity",
  "name": "PostDock Tanimoto ROSHAMBO sim",
  "specific_parameters": {
    "shape_weight": 1.0,
    "color_weight": 0.0,
    "similarity_measure": "Tanimoto",

    "roshambo_input": "/path/to/reference_warheads.sdf",     
    "docked_poses_path": "/path/to/docked/results",

    "save_overlays": true,
    "overlays_dir": "/path/to/roshambo_overlays",

    "roshambo_api_url": "http://127.0.0.1:5000",
    "gpu_id": 0,
    "ignore_hs": true,
    "use_carbon_radii": true,
    "n_confs": 0
  },
  "weight": 1
}
```

Notes:
- `roshambo_input` can also be specified as `reference_file`; both are accepted.
- `n_confs` defaults to 0 for SDF datasets to use the pre‑existing conformers (from docking/extraction).

## Parameters

Required
- `roshambo_input` or `reference_file`: Path to the reference warheads SDF
- `docked_poses_path`: Path to the directory containing `e####_ADV_ligands_docked.sdf`

Recommended
- `save_overlays` (bool): Whether to keep overlays outputs (default: true)
- `overlays_dir` (string): Directory for all PostDock outputs
- `roshambo_api_url` (string): Roshambo API base URL (default: `http://127.0.0.1:5000`)
- `gpu_id` (int): GPU to use (default: 0)
- `shape_weight`, `color_weight`: Weights for shape/color similarity (default: 1.0 and 0.0)

Optional
- `ignore_hs` (bool): Ignore hydrogens in Roshambo (default: true)
- `use_carbon_radii` (bool): Use carbon radii in Roshambo (default: true)
- `n_confs` (int): Conformers for SMILES datasets; for SDF inputs leave 0
- `similarity_measure` (string): Informational; CSV extraction uses Shape/Color or Combo columns

## How it works (step-by-step)

1) Initialize component
- Creates the overlays directory if needed
- Copies the reference SDF into overlays on first use (idempotent)

2) Resolve epoch filename
- For step k (0‑based), the component constructs the docked SDF name: `e{(k+1):04d}_ADV_ligands_docked.sdf`
- If `step < 0`, it scans `docked_poses_path` for the latest available epoch file

3) Extract warheads
- Uses the repository’s extractor to write `eXXXX_e_warheads.sdf` in the overlays directory:
  - `extract_warheads_to_file(reference_sdf, docked_sdf, output_sdf)`
- Preserves coordinates and fixes common sanitization issues

4) Call Roshambo API
- Sends filename‑only `reference_file` and `dataset_file`, with `working_dir` set to overlays
- `output_prefix` is set to `eXXXX_` so Roshambo writes `eXXXX_roshambo.csv`, `eXXXX_mols.sdf`, `eXXXX_hits.sdf`

5) Parse scores
- Reads `eXXXX_roshambo.csv` and computes scores:
  - If `ShapeTanimoto` and `ColorTanimoto` exist, uses weighted sum
  - Else if `ComboTanimoto` exists, uses that
- Maps back by `OriginalName` expecting `mol_i` or `mol_i_*` naming; takes the max per `i`

6) Returns scores
- Returns a dense numpy array of scores aligned with the batch order

## File naming expectations

- Docked file: `e####_ADV_ligands_docked.sdf` under `docked_poses_path`
- Extracted warheads (Roshambo input): `e####_e_warheads.sdf` under `overlays_dir`
- Roshambo outputs: `e####_mols.sdf`, `e####_hits.sdf`, `e####_roshambo.csv` in `overlays_dir`

## Troubleshooting

- No docked file found
  - Ensure the epoch file exists under `docked_poses_path` with the exact name format
- Extraction produced 0 warheads
  - Confirm the reference warheads match substructures in the docked PROTACs
  - Try enabling MCS fallback (default is on) or lowering `mcs_threshold`
- Roshambo API returns success but no CSV
  - Confirm Roshambo has write permissions to `overlays_dir`
  - Check your Roshambo API logs
- CSV parsed but zeros returned
  - Verify CSV contains expected columns: `OriginalName` plus `ShapeTanimoto`/`ColorTanimoto` or `ComboTanimoto`
  - Confirm `OriginalName` follows `mol_i` or `mol_i_*` naming

## Minimal verification checklist

- [ ] overlays_dir is created and contains the copied reference SDF
- [ ] The appropriate `e####_ADV_ligands_docked.sdf` exists in `docked_poses_path`
- [ ] `e####_e_warheads.sdf` gets created in overlays_dir
- [ ] Roshambo writes `e####_roshambo.csv` in overlays_dir
- [ ] Scores are non‑zero for expected molecules

## Where to find the code

- Component: `reinvent_scoring/scoring/score_components/postdock/postdock_shape_similarity.py`
- Extractor API: `reinvent_scoring/scoring/score_components/postdock/extraction_warheads.py`
- Roshambo component pattern: `reinvent_scoring/scoring/score_components/roshambo/roshambo_shape_similarity.py`

## Example: switching to `reference_file`

```json
{
  "component_type": "docked_parallel_roshambo_similarity",
  "specific_parameters": {
    "reference_file": "/data/ref_warheads.sdf",
    "docked_poses_path": "/data/docked/BTK",
    "overlays_dir": "/data/overlays/BTK",
    "shape_weight": 1.0,
    "color_weight": 0.0
  },
  "weight": 1
}
```

